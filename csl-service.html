<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSL åˆ¶è£åå•ç­›æŸ¥ | Legal AI Service</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-card: #161618;
            --bg-card-hover: #1c1c1f;
            --border: #2a2a2e;
            --border-hover: #3a3a3f;
            --text-primary: #f0f0f2;
            --text-secondary: #8a8a8e;
            --text-dim: #5a5a5e;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --font-sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .grid-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        header {
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.15s;
        }

        .back-link:hover { color: var(--text-primary); }

        .header-badge {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .title-section {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .title-icon { font-size: 2.5rem; margin-bottom: 1rem; }

        .title-section h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .title-section p {
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto;
        }

        .api-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .api-section summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .api-section summary:hover { color: var(--text-primary); }

        .api-section[open] summary {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .api-group { margin-bottom: 1.25rem; }
        .api-group:last-child { margin-bottom: 0; }

        .api-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-input-group { display: flex; gap: 0.75rem; }

        .api-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .api-save-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .api-save-btn:hover { background: var(--border); }

        .api-hint {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .api-hint a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .api-status {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
        }

        .api-status-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .api-status-item.ok { color: var(--accent-green); }
        .api-status-item.missing { color: var(--accent-orange); }
        .api-status-item.error { color: var(--accent-red); }

        .search-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 1.25rem;
        }

        .search-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            padding-right: 130px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: var(--font-sans);
            transition: border-color 0.15s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-red);
        }

        .search-input::placeholder { color: var(--text-dim); }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.75rem 1.5rem;
            background: var(--accent-red);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .search-btn:hover { background: #dc2626; }
        .search-btn:disabled { background: var(--border); cursor: not-allowed; }

        .search-options {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .option-label input {
            accent-color: var(--accent-red);
            width: 16px;
            height: 16px;
        }

        .translation-preview {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .translation-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .translation-variants {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .variant-tag {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .status {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .status.loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-count {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .results-count .number { color: var(--accent-orange); }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent-red);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.15s;
        }

        .result-card:hover {
            border-color: var(--border-hover);
            transform: translateX(4px);
        }

        .result-name {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
        }

        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .meta-item {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .meta-item strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        .result-source {
            display: inline-block;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .result-aliases {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .result-aliases strong { color: var(--text-primary); }

        .clear-result {
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
        }

        .clear-icon {
            width: 64px;
            height: 64px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1rem;
        }

        .clear-result h3 {
            color: var(--accent-green);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .clear-result p { color: var(--text-secondary); }

        footer {
            border-top: 1px solid var(--border);
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
        }

        .footer-content {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .footer-content a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .source-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .source-legend span { font-family: var(--font-mono); }

        @media (max-width: 640px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .search-input { padding-right: 1rem; }
            .search-btn {
                position: static;
                transform: none;
                width: 100%;
                margin-top: 0.75rem;
                padding: 1rem;
            }
            .search-input-wrapper { display: flex; flex-direction: column; }
            .api-input-group { flex-direction: column; }
            .container { padding: 0 1rem; }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>

    <div class="container">
        <header>
            <div class="header-content">
                <a href="index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
                <div class="header-badge">CSL Screening</div>
            </div>
        </header>

        <section class="title-section">
            <div class="title-icon">ğŸ›¡ï¸</div>
            <h1>CSL åˆ¶è£åå•ç­›æŸ¥</h1>
            <p>æ”¯æŒä¸­è‹±æ–‡è¾“å…¥ï¼ŒAI æ™ºèƒ½ç¿»è¯‘åŒ¹é…ç¾å›½ç»¼åˆç­›æŸ¥åå•</p>
        </section>

        <details class="api-section" id="apiSection" open>
            <summary>âš™ï¸ API è®¾ç½®</summary>
            
            <div class="api-group">
                <div class="api-label">ğŸ”‘ CSL API Keyï¼ˆå¿…éœ€ï¼‰</div>
                <div class="api-input-group">
                    <input type="password" class="api-input" id="cslApiKeyInput" placeholder="è¾“å…¥ Trade.gov Subscription Key">
                    <button class="api-save-btn" onclick="saveCslApiKey()">ä¿å­˜</button>
                </div>
                <p class="api-hint">
                    è·å–æ–¹å¼ï¼š<a href="https://developer.trade.gov/" target="_blank">developer.trade.gov</a> â†’ æ³¨å†Œ â†’ Products â†’ è®¢é˜… Data Services Platform APIs
                </p>
            </div>

            <div class="api-group">
                <div class="api-label">ğŸ¤– DeepSeek API Keyï¼ˆå¯é€‰ï¼Œç”¨äºä¸­æ–‡ç¿»è¯‘ï¼‰</div>
                <div class="api-input-group">
                    <input type="password" class="api-input" id="deepseekApiKeyInput" placeholder="è¾“å…¥ DeepSeek API Keyï¼ˆå¯é€‰ï¼‰">
                    <button class="api-save-btn" onclick="saveDeepseekApiKey()">ä¿å­˜</button>
                </div>
                <p class="api-hint">
                    è·å–æ–¹å¼ï¼šè®¿é—® <a href="https://platform.deepseek.com/" target="_blank">platform.deepseek.com</a>ï¼ˆä¸é…ç½®ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†ä¸­æ–‡æœç´¢æ•ˆæœè¾ƒå·®ï¼‰
                </p>
            </div>

            <div class="api-status" id="apiStatus"></div>
        </details>

        <div class="search-container">
            <div class="search-input-wrapper">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="è¾“å…¥å…¬å¸æˆ–ä¸ªäººåç§°ï¼Œå¦‚ï¼šHuaweiã€åä¸ºã€ZTE..."
                    onkeypress="if(event.key === 'Enter') performSearch()"
                >
                <button class="search-btn" id="searchBtn" onclick="performSearch()">å¼€å§‹ç­›æŸ¥</button>
            </div>
            <div class="search-options">
                <label class="option-label">
                    <input type="checkbox" id="fuzzySearch" checked>
                    å¯ç”¨æ¨¡ç³ŠåŒ¹é…
                </label>
                <label class="option-label">
                    <input type="checkbox" id="useAiTranslation" checked>
                    AI ä¸­æ–‡ç¿»è¯‘
                </label>
            </div>
        </div>

        <div id="translationPreview"></div>
        <div id="resultsArea"></div>

        <footer>
            <div class="footer-content">
                <div class="source-legend">
                    <span>SDN = OFAC ç‰¹åˆ«æŒ‡å®šå›½æ°‘</span>
                    <span>EL = å®ä½“æ¸…å•</span>
                    <span>DPL = æ‹’ç»äººå‘˜æ¸…å•</span>
                    <span>UVL = æœªç»éªŒè¯æ¸…å•</span>
                </div>
                <p>
                    æ•°æ®æ¥æºï¼š<a href="https://www.trade.gov/consolidated-screening-list" target="_blank">U.S. ITA Consolidated Screening List</a>
                    Â· æœ¬å·¥å…·ä»…ä¾›å‚è€ƒ
                </p>
            </div>
        </footer>
    </div>

    <script>
        // ===== é…ç½® =====
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';
        // æ­£ç¡®çš„ CSL API URL
        const CSL_API_URL = 'https://data.trade.gov/consolidated_screening_list/v1/search';

        // ===== API Key ç®¡ç† =====
        function saveDeepseekApiKey() {
            const key = document.getElementById('deepseekApiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('deepseek_api_key', key);
                updateApiStatus();
                alert('DeepSeek API Key å·²ä¿å­˜');
            }
        }

        function getDeepseekApiKey() {
            return localStorage.getItem('deepseek_api_key');
        }

        function saveCslApiKey() {
            const key = document.getElementById('cslApiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('csl_api_key', key);
                updateApiStatus();
                alert('CSL API Key å·²ä¿å­˜');
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
            }
        }

        function getCslApiKey() {
            return localStorage.getItem('csl_api_key');
        }

        function updateApiStatus() {
            const deepseekKey = getDeepseekApiKey();
            const cslKey = getCslApiKey();
            const statusHtml = `
                <span class="api-status-item ${cslKey ? 'ok' : 'error'}">
                    ${cslKey ? 'âœ“' : 'âœ—'} CSL APIï¼ˆå¿…éœ€ï¼‰
                </span>
                <span class="api-status-item ${deepseekKey ? 'ok' : 'missing'}">
                    ${deepseekKey ? 'âœ“' : 'â—‹'} DeepSeekï¼ˆä¸­æ–‡ç¿»è¯‘ï¼Œå¯é€‰ï¼‰
                </span>
            `;
            document.getElementById('apiStatus').innerHTML = statusHtml;
        }

        window.onload = function() {
            const deepseekKey = getDeepseekApiKey();
            if (deepseekKey) {
                document.getElementById('deepseekApiKeyInput').value = deepseekKey;
            }
            const cslKey = getCslApiKey();
            if (cslKey) {
                document.getElementById('cslApiKeyInput').value = cslKey;
            }
            updateApiStatus();
            document.getElementById('searchInput').focus();
        };

        // ===== AI ç¿»è¯‘ =====
        async function translateToEnglish(chineseName) {
            const apiKey = getDeepseekApiKey();
            if (!apiKey) {
                return [chineseName];
            }

            const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­è‹±æ–‡ç¿»è¯‘åŠ©æ‰‹ï¼Œä¸“é—¨å¤„ç†å…¬å¸åç§°å’Œäººåçš„ç¿»è¯‘ã€‚

è¯·å°†ä»¥ä¸‹åç§°ç¿»è¯‘æˆæ‰€æœ‰å¯èƒ½çš„è‹±æ–‡å˜ä½“ã€‚è€ƒè™‘ï¼š
1. å®˜æ–¹è‹±æ–‡åç§°
2. æ‹¼éŸ³éŸ³è¯‘
3. æ„è¯‘
4. å¸¸è§çš„ç®€ç§°æˆ–ç¼©å†™
5. å¯èƒ½çš„åˆ«å

è¾“å…¥åç§°ï¼š${chineseName}

è¯·åªè¿”å› JSON æ•°ç»„æ ¼å¼ï¼Œä¸è¦å…¶ä»–è§£é‡Šï¼Œä¾‹å¦‚ï¼š
["Huawei", "Huawei Technologies", "Huawei Technologies Co., Ltd."]

å¦‚æœè¾“å…¥å·²ç»æ˜¯è‹±æ–‡ï¼Œä¹Ÿè¯·è¿”å›å¯èƒ½çš„å˜ä½“å½¢å¼ã€‚`;

            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    console.error('DeepSeek API error:', response.status);
                    return [chineseName];
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.error('Translation error:', e);
            }
            
            return [chineseName];
        }

        // ===== CSL æŸ¥è¯¢ =====
        async function searchCSL(name, fuzzy = true) {
            const apiKey = getCslApiKey();
            console.log('CSL API Key:', apiKey ? `${apiKey.substring(0, 8)}...` : 'NULL');
            
            if (!apiKey) {
                throw new Error('è¯·å…ˆé…ç½® CSL API Key');
            }

            const params = new URLSearchParams();
            // é€šè¿‡ URL å‚æ•°ä¼ é€’ subscription keyï¼ˆé¿å… CORS é¢„æ£€é—®é¢˜ï¼‰
            params.append('subscription-key', apiKey);
            
            if (fuzzy) {
                params.append('name', name);
                params.append('fuzzy_name', 'true');
            } else {
                params.append('q', name);
            }

            const url = `${CSL_API_URL}?${params}`;
            console.log('CSL API URL:', url);

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('CSL API Error:', response.status, errorText);
                if (response.status === 401 || response.status === 403) {
                    throw new Error('CSL API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                }
                throw new Error(`CSL API é”™è¯¯ (${response.status})`);
            }

            const data = await response.json();
            console.log('CSL Response:', data);
            return data.results || [];
        }

        // ===== ç»“æœå»é‡ =====
        function deduplicateResults(results) {
            const seen = new Set();
            return results.filter(item => {
                const key = `${item.name}-${item.source}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // ===== ä¸»æœç´¢æµç¨‹ =====
        async function performSearch() {
            const input = document.getElementById('searchInput').value.trim();
            const fuzzy = document.getElementById('fuzzySearch').checked;
            const useAi = document.getElementById('useAiTranslation').checked;
            const resultsArea = document.getElementById('resultsArea');
            const transPreview = document.getElementById('translationPreview');
            const searchBtn = document.getElementById('searchBtn');

            if (!input) {
                alert('è¯·è¾“å…¥è¦ç­›æŸ¥çš„åç§°');
                return;
            }

            // æ£€æŸ¥ CSL API Key
            if (!getCslApiKey()) {
                alert('è¯·å…ˆåœ¨ä¸Šæ–¹é…ç½® CSL API Key');
                document.getElementById('apiSection').open = true;
                document.getElementById('cslApiKeyInput').focus();
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'ç­›æŸ¥ä¸­...';
            transPreview.innerHTML = '';
            resultsArea.innerHTML = `
                <div class="status loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¿›è¡Œæ™ºèƒ½ç­›æŸ¥...</div>
                </div>
            `;

            try {
                const hasChinese = /[\u4e00-\u9fa5]/.test(input);
                let searchVariants = [input];

                if (hasChinese && useAi && getDeepseekApiKey()) {
                    resultsArea.innerHTML = `
                        <div class="status loading">
                            <div class="spinner"></div>
                            <div>AI æ­£åœ¨è¯†åˆ«è‹±æ–‡åç§°å˜ä½“...</div>
                        </div>
                    `;
                    
                    const translated = await translateToEnglish(input);
                    searchVariants = [...new Set([input, ...translated])];
                    
                    if (translated.length > 1 || translated[0] !== input) {
                        transPreview.innerHTML = `
                            <div class="translation-preview">
                                <div class="translation-label">// AI è¯†åˆ«çš„è‹±æ–‡å˜ä½“</div>
                                <div class="translation-variants">
                                    ${translated.map(v => `<span class="variant-tag">${v}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                resultsArea.innerHTML = `
                    <div class="status loading">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨æŸ¥è¯¢ CSL æ•°æ®åº“ï¼ˆ${searchVariants.length} ä¸ªå˜ä½“ï¼‰...</div>
                    </div>
                `;

                let allResults = [];
                for (const variant of searchVariants) {
                    try {
                        const results = await searchCSL(variant, fuzzy);
                        allResults = allResults.concat(results);
                    } catch (e) {
                        console.error(`Search failed for ${variant}:`, e);
                    }
                }

                const uniqueResults = deduplicateResults(allResults);
                displayResults(uniqueResults, input);

            } catch (error) {
                resultsArea.innerHTML = `
                    <div class="status" style="color: var(--accent-red);">
                        âŒ æŸ¥è¯¢å‡ºé”™ï¼š${error.message}
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'å¼€å§‹ç­›æŸ¥';
            }
        }

        // ===== æ˜¾ç¤ºç»“æœ =====
        function displayResults(results, query) {
            const resultsArea = document.getElementById('resultsArea');

            if (results.length === 0) {
                resultsArea.innerHTML = `
                    <div class="clear-result">
                        <div class="clear-icon">âœ“</div>
                        <h3>æœªå‘ç°åŒ¹é…è®°å½•</h3>
                        <p>ã€Œ${query}ã€åœ¨ CSL ç»¼åˆç­›æŸ¥åå•ä¸­æœªæ‰¾åˆ°åŒ¹é…é¡¹</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="results-header">
                    <div class="results-count">
                        âš ï¸ å‘ç° <span class="number">${results.length}</span> æ¡æ½œåœ¨åŒ¹é…
                    </div>
                </div>
            `;

            results.forEach(item => {
                const aliases = item.alt_names ? item.alt_names.split(';').filter(a => a.trim()) : [];
                const addresses = item.addresses ? 
                    (Array.isArray(item.addresses) ? item.addresses.map(a => a.address || a).join(', ') : String(item.addresses)) 
                    : '';
                
                html += `
                    <div class="result-card">
                        <div class="result-name">${item.name || 'N/A'}</div>
                        <div class="result-meta">
                            <span class="meta-item"><strong>ç±»å‹:</strong> ${item.type || 'N/A'}</span>
                            <span class="meta-item"><strong>å›½å®¶:</strong> ${item.country || item.countries || 'N/A'}</span>
                            ${addresses ? `<span class="meta-item"><strong>åœ°å€:</strong> ${addresses.slice(0, 80)}${addresses.length > 80 ? '...' : ''}</span>` : ''}
                        </div>
                        <span class="result-source">${item.source || 'Unknown'}</span>
                        ${aliases.length > 0 ? `
                            <div class="result-aliases">
                                <strong>åˆ«åï¼š</strong>${aliases.slice(0, 5).join(' Â· ')}${aliases.length > 5 ? ' ...' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            resultsArea.innerHTML = html;
        }
    </script>
</body>
</html>
